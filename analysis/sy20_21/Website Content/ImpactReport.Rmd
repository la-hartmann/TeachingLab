---
title: "Impact Report Visualizations"
author: "Duncan Gates"
date: "7/13/2021"
output:
  html_document:
  theme: paper
highlight: kate
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F, message = F, warning = F)
library(tidyverse)
library(here)
library(ggtext)
library(systemfonts)
devtools::load_all()
library(TeachingLab)
```

# Average Math and ELA Scores

```{r}
math_and_ela <- tibble(
  score = c(55, 54, 71, 67),
  score_label = c("55%\n(2019-2020)", "54%\n(2019-2020)", "71%\n(2020-2021)", "67%\n(2020-2021)"),
  type = c("ELA", "Math", "ELA", "Math"),
  year = factor(c("2019", "2019", "2020", "2020"))
)

ela_continuous <- tibble(
  x = math_and_ela$type[1], 
  y = seq(math_and_ela$score[1], math_and_ela$score[3] - 0.01, 0.01),
  xend = math_and_ela$type[3], 
  yend = seq(math_and_ela$score[1] + 0.01, math_and_ela$score[3], 0.01),
  size = seq(1, 7.5, l = 1600)
)

math_continuous <- tibble(
  x = math_and_ela$type[2], 
  y = seq(math_and_ela$score[2], math_and_ela$score[4] - 0.01, 0.01),
  xend = math_and_ela$type[4], 
  yend = seq(math_and_ela$score[2] + 0.01, math_and_ela$score[4], 0.01),
  size = seq(1, 5, l = 1300)
)

math_and_ela %>%
  ggplot() +
  # geom_point(aes(x = type, y = score, color = type, size = score)) +
  geom_curve(data = ela_continuous,
             alpha = 0.9, aes(x = x, y = y,
                 xend = xend, yend = yend, size = size), 
             linetype = "solid", color = "#04abeb", angle = 0) +
  geom_segment(aes(x = ela_continuous$x[1], xend = ela_continuous$xend[1],
                   y = dplyr::last(ela_continuous$y), yend = dplyr::last(ela_continuous$y[-1]+0.01)),
               size = 7.5, arrow = arrow(length = unit(1,"cm")),
               color = "#04abeb",
               alpha = 0.7) +
  geom_curve(data = math_continuous,
             alpha = 0.9, aes(x = x, y = y,
                 xend = xend, yend = yend, size = size), 
             linetype = "solid", color = "#d17df7", angle = 0) +
  geom_segment(aes(x = math_continuous$x[1], xend = math_continuous$xend[1],
                   y = dplyr::last(math_continuous$y), yend = dplyr::last(math_continuous$y[-1]+0.01)),
               size = 5, arrow = arrow(length = unit(1,"cm")),
               color = "#d17df7",
               alpha = 0.7) +
  ggrepel::geom_text_repel(aes(x = type, y = score, label = score_label, color = type),
                segment.color = NA, force = 1, nudge_x = 0.35,
                size = 8.5) +
  scale_size_identity() +
  # scale_x_discrete(labels = c("2019-2020", "2020-2021")) +
  labs(x = "", y = "", title = "Average <span style = 'color:#04abeb;'>ELA</span> and <span style = 'color:#d17df7;'>Math</span> scores in 2019-2020 and 2020-2021") +
  scale_color_manual(values = c("#04abeb", "#d17df7")) +
  scale_y_continuous(labels = scales::percent_format(scale = 1), limits = c(50, 80)) +
  theme_tl() +
  theme(plot.title = element_markdown(size = 18),
        axis.text = element_text(size = 15))

ggsave(here("Images/2020-2021/ImpactReport/ELAandMathAverage.png"), width = 10, height = 8)
```

# Second Chart

```{r}
ggplot_data_compare <- math_and_ela %>%
  rename(prepost = year, Question = type)

ggplot_data_compare$Question <- factor(ggplot_data_compare$Question, levels = ggplot_data_compare$Question %>% unique() %>% as_vector() %>% rev())

ggplot(ggplot_data_compare, aes(x = Question, y = score, fill = prepost)) +
  geom_col(position = position_dodge2(reverse = T)) +
  geom_text(aes(label = paste0(score, "%"), color = prepost), position = position_dodge2(width = 1, reverse = T), hjust = -0.35, size = 5) +
  coord_flip() +
  labs(x = "", y = "", 
       title = "Scores for 1st year vs <span style = 'color:#04abeb'>returning </span>  <img src = 'https://images.squarespace-cdn.com/content/v1/5e9e07cd7714da42bfa89f6e/1587415133627-QY4HDP76E7QRG9UU4NDL/Teaching+Lab+Logo+HORIZONTAL.png', width = '70', height = '20' /> <br> professional learning participants") +
  scale_fill_tl(n = 2, labels = c("First Year\nParticipants", "Second Year\nParticipants")) +
  scale_color_tl(n = 2) +
  scale_y_continuous(labels = percent_format(scale = 1), limits = c(0, 105)) +
  theme_tl() +
  theme(
    axis.text.y = element_markdown(size = 15, hjust = 0.5, lineheight = 1.1),
    plot.title = element_markdown(lineheight = 1.2, size = 20),
    axis.text.x = element_markdown(size = 15))

ggsave(here::here("Images/2020-2021/ImpactReport/ScoresFirstvsSecondYearELAandMath.png"), width = 12, height = 8)
```


# Quotes

```{r}
dashboard_data <- read_rds(here("Data/Dashboard Data/dashboard_data.rds"))
comments <- dashboard_data %>%
  filter(`How Likely Are You To Recommend This Professional Learning To A Colleague Or Friend?` == 9 |
           `How Likely Are You To Recommend This Professional Learning To A Colleague Or Friend?` == 10) %>%
  select(`Date for the session`,
         `Do you have additional comments?`,
         `Overall, what went well in this professional learning?`#,
         # `Why did you choose this rating?`
         ) %>%
  pivot_longer(!c(`Date for the session`), names_to = "Question", values_to = "Response") %>%
  filter(!is.na(Response) & 
           Response != "No Response" &
           str_length(Response) > 150 &
           `Date for the session` > "2020-06-30") %>%
  select(-1) %>%
  distinct(Response, .keep_all = T)
```

# Quote Sampling

```{r}
comments_10 <- comments %>%
  slice(c(122, 119, 99, 94, 81, 51, 39, 57, 45, 27))


TeachingLab::quote_viz(comments_10, Response, "gt", highlight = c("teacher", "time", "learning"))

gtsave(here("Images/2020-2021/ImpactReport/quotes10.png"))
```

# Tidy Text Based

```{r}
library(tidytext)
data("stop_words")
words <- comments %>%
  select(-1) %>%
  unnest_tokens(word, Response) %>%
  anti_join(stop_words) %>%
  group_by(word) %>%
  count(sort = T)

wordcloud <- comments %>%
  filter(str_detect(Response, paste(words$word[1:3], collapse = "|")))

tl_wordcloud(data = wordcloud, text_col = "Response", colors = c(tl_palette(theme = "dark", n = 8, color = "blue")[2],
                                                                 tl_palette(theme = "dark", n = 2, color = "blue")[2]), 
             n_min = 3,
             size = 15,
             shape = "circle")

ggsave(here("Images/2020-2021/ImpactReport/quoteswordcloud.png"))
```

# Comments Already in Report

```{r}
library(tidytext)
data("stop_words")

comments <- tibble(Response = c("“Efficient and no nonsense approach to learning about guidebooks. Teacher's time is valuable and precious and this method honored that.”-Guidebooks Abbreviated Bootcamp",
  "“I feel prepare to use EL, but even more so I understand HOW to incorporate the shifts into instruction and WHY they are important.”-EL EL Bootcamp: Modules (K-8)",
  "“Very informative and provides a clear roadmap to instructionally plan.”- Accelerating Learning in Math",
  "“Eureka math can be quite intimidating when you first look at the curriculum. This bootcamp really helps you understand why Eureka is laid out the way it is and how it nurtures all levels of math learners in your classroom.”-EngageNY K-5 Bootcamp",
  "“The information was priceless and you get to talk with other professionals.”-Math Curriculum Flexible Day 2",
  "“This is extremely valuable in furthering my knowledge and abilities.”-DE Curriculum Flexible Cycle 1 - Opening",
  "“It was a great course - learning was to help us best support our student needs. I loved how much we were required to reflect on our teaching”-Fort Dodge K-2 Skills Cycle 1: Using Data to Inform Instruction",
  "“The boot camp was informative and meaningful. I have a greater understanding of EL education and will apply my learning to my practice.”-EL EL Bootcamp: Modules (K-8)",
  "“Informative and able to apply to my teaching. This PD wasn't selling a product they were giving practices.”-Illustrative Mathematics EngageNY 6-12 Bootcamp",
  "“Engaging, content rich, community environment of learners, skilled facilitators.”-EL Bootcamp: Modules (K-8)",
  "“The topics are relevant and in high stakes areas that aid in the development of a great teacher.”-Calcasieu Diverse Learners Teacher Bootcamp")
)

words <- comments %>%
  unnest_tokens(word, Response) %>%
  anti_join(stop_words) %>%
  group_by(word) %>%
  count(sort = T)

wordcloud <- comments %>%
  filter(str_detect(Response, paste(words$word[1:3], collapse = "|")))

tl_wordcloud(data = wordcloud, text_col = "Response", colors = c(tl_palette(theme = "dark", n = 8, color = "blue")[2],
                                                                 tl_palette(theme = "dark", n = 2, color = "blue")[2]), 
             n_min = 1,
             size = 15,
             shape = "cardioid")

ggsave(here("Images/2020-2021/ImpactReport/impactreport_quoteswordcloud.png"))
```

```{r}
TeachingLab::quote_viz(comments, Response, viz_type = "gt", highlight = c("informative", "learning",
                                                                          "teaching", "information",
                                                                          "learners"), width = 90) %>% gtsave(here("Images/2020-2021/ImpactReport/Quotes.png"))
```


# Testing for html text coloring

```{r}
fake_data <- tibble(number = c(1, 2, 3, 4, 5),
                    text = c("blah blah yes and no", "something or other no", "hahahahaa maybe", "dfasdffd", "dfasdfafddf"))

highlight = c("yes", "no", "maybe")
check <- map(highlight, ~ str_replace_all(fake_data$text, .x, paste0("<span style='color:#04abeb'>", .x, "</span>"))) %>%
  enframe()
```

```{r}
v<- c("kpX_43", "kpX_10", "kpX_11")

strings<- as.matrix(c(seq(1:3), "a1"))

v %>% map(., ~str_c(., letters[seq(from = 1, to = 2)])) %>%
      map(. %>% map(.,~str_replace_all(.,'X',strings))) %>% unlist()
```

```{r}
x <- comments$Response
highlight = c("informative", "learning", "learners", "teachers", "instruction")
map(x, ~ map_chr(highlight, ~ str_replace_all(x, .x, paste0("<span style='color:#04abeb'>", .x, "</span>"))))
map(highlight, ~ str_replace_all(x, .x, paste0("<span style='color:#04abeb'>", .x, "</span>")))
```



# Comparing First and Second Year Participants

```{r}
data_one <- readxl::read_excel(here("Data/SY19-20/SY19-20 Fall-Spring Merged Dataset Update.xls"))

data_two <- read_rds(here("Data/SY20-21/full_2021.rds"))

participants19and20 <- data_one$id[which(data_one$id %in% data_two$id)]
```

```{r}
negative_vector <- c("Very untrue", "Untrue")
positive_vector <- c("Very true", "True")
mindsets_one <- data_one %>% 
  filter(id %in% participants19and20)

mindsets_index_one <- tibble(question_pre = c("pre1", "pre2", "pre3", "pre4", 
                                              "pre5", "pre6", "pre7", "pre8", 
"pre9"),
                question_post = c("pre1", "pre2", "pre3", "pre4", 
                                  "pre5", "pre6", "pre7", "pre8", 
"pre9"),
                coding = list(negative_vector, positive_vector, negative_vector, negative_vector, positive_vector,
                              positive_vector, positive_vector, negative_vector, negative_vector))

mindsets_data_two <- pmap_df(list(mindsets_index_one$question_pre, 
                                  mindsets_index_one$question_post, 
                                  mindsets_index_one$coding), 
                                   ~ score_question_improved(mindsets_one, 
                                                             question_pre = ..1, question_post = ..2, coding = ..3, middle_value = "Somewhat true"))
mindsets_data_two %>% slice(c(1:2)) %>% summarise(mean(pre_percent))
mindsets_data_two %>% slice(c(3:4)) %>% summarise(mean(pre_percent))
mindsets_data_two %>% slice(c(5, 7:9)) %>% summarise(mean(pre_percent))
```

```{r}
mindsets_two <- data_two %>%
  filter(id %in% participants19and20)

positive_vector <- c("4", "5")
negative_vector <- c("1", "2")

mindsets_index_two <- tibble(question_pre = c("prerace1", "prerace2", "prehigh2", "prehigh3", "prehigh4", "prehigh1", "pregrowth1", "pregrowth2", "preacc1", "preacc2", "preacc3"),
                question_post = c("postrace1", "postrace2", "posthigh2", "posthigh3", "posthigh4", "posthigh1", "postgrowth1", "postgrowth2", "postacc1", "postacc2", "postacc3"),
                coding = list(negative_vector, negative_vector, negative_vector, negative_vector, negative_vector, positive_vector, negative_vector, negative_vector, positive_vector, positive_vector, positive_vector))

mindsets_data_two <- pmap_df(list(mindsets_index_two$question_pre, mindsets_index_two$question_post, mindsets_index_two$coding), 
                                   ~ score_question_improved(mindsets_two, 
                                                             question_pre = ..1, question_post = ..2, coding = ..3, middle_value = "3"))
mindsets_data_two %>% slice(c(1:2)) %>% summarise(mean(pre_percent))
mindsets_data_two %>% slice(c(3:6)) %>% summarise(mean(pre_percent))
mindsets_data_two %>% slice(c(7:8)) %>% summarise(mean(pre_percent))
mindsets_data_two %>% slice(c(9:11)) %>% summarise(mean(pre_percent))
```

# Second Try

```{r}
data_2021 <- read_rds(here("Data/SY20-21/full_2021.rds"))

prior_part <- data_2021 %>%
  filter(pre_priorpart == "Yes") %>%
  distinct(id, .keep_all = T)

no_priorpart <- data_2021 %>%
  filter(pre_priorpart == "No") %>%
  distinct(id, .keep_all = T)

positive_vector <- c("4", "5")
negative_vector <- c("1", "2")

mindsets_index <- tibble(question_pre = c("prerace1", "prerace2", "prehigh2", "prehigh3", "prehigh4", "prehigh1", "pregrowth1", "pregrowth2", "preacc1", "preacc2", "preacc3"),
                question_post = c("postrace1", "postrace2", "posthigh2", "posthigh3", "posthigh4", "posthigh1", "postgrowth1", "postgrowth2", "postacc1", "postacc2", "postacc3"),
                coding = list("negative", "negative", "negative", "negative", "negative", "positive", "negative", "negative", "positive", "positive", "positive"))

mindsets_data_one <- pmap_df(list(mindsets_index$question_pre, mindsets_index$question_post, mindsets_index$coding), 
                                   ~ score_question_mindsets(prior_part, na_remove = F,
                                                             question_pre = ..1, question_post = ..2, coding = ..3, likert = 5))

mindsets_data_two <- pmap_df(list(mindsets_index$question_pre, mindsets_index$question_post, mindsets_index$coding), 
                                   ~ score_question_mindsets(no_priorpart, na_remove = F,
                                                             question_pre = ..1, question_post = ..2, coding = ..3, likert = 5))

full_mindsets_score <- bind_cols(mindsets_data_two, mindsets_data_one)


one <- full_mindsets_score %>% slice(c(1:2)) %>% 
  summarise(across(contains("pre"), ~ mean(.x))) %>%
  rename(`First Year Participants` = 1, `Second Year Participants` = 2)
two <- full_mindsets_score %>% slice(c(3:6)) %>% 
  summarise(across(contains("pre"), ~ mean(.x))) %>% 
  rename(`First Year Participants` = 1, `Second Year Participants` = 2)
three <- full_mindsets_score %>% slice(c(7:8)) %>% 
  summarise(across(contains("pre"), ~ mean(.x))) %>% 
  rename(`First Year Participants` = 1, `Second Year Participants` = 2)
four <- full_mindsets_score %>% slice(c(9:11)) %>% 
  summarise(across(contains("pre"), ~ mean(.x))) %>% 
  rename(`First Year Participants` = 1, `Second Year Participants` = 2)

gt_data_compare <- bind_rows(one, two, three, four) %>%
  map_df( ~ c(.x, mean(.x))) %>%
  mutate(across(everything(), ~ round2(.x, n = 0))) %>%
  mutate(`Mindset` = c("Recognition of Race and Ethnicity", "Growth Mindsets", "High Expectations", "Accountability for Requitable Instruction", "Overall")) %>%
  mutate(across(where(is.double), ~ as.integer(.x)))

gt_data_compare_last_row <- gt_data_compare %>%
  slice_tail()

gt_data_compare <- bind_rows(gt_data_compare_last_row, gt_data_compare) %>%
  slice(-6)

gt_data_compare %>%
  TeachingLab::gt_arrow(colors = c("#800000", "#98AFC7"), 
                        column_one = "First Year Participants", 
                        column_two = "Second Year Participants") %>%
  gt(rowname_col = "Mindset") %>%
  # gt_tl_color(color = "blue", column = "Second Year Participants", scale = 1) %>%
  gt::tab_style(
      style = list(
        cell_fill(color = "#89d7f7")
      ),
      locations = cells_body(
        columns = c(`Second Year Participants`),
        rows = c(`Second Year Participants`) < 40
      )
    ) %>%
  gt::cols_label(
    Improvement = html("Returning Participants vs. 1st Year"),
    `Second Year Participants` = html("<span style = 'color:#04abeb'>Returning Participants</span>")
  ) %>%
  gt::tab_style(
      style = list(
        cell_fill(color = "#52c6f4")
      ),
      locations = cells_body(
        columns = c(`Second Year Participants`),
        rows = c(`Second Year Participants`) >= 40
      )
    ) %>%
  gt::tab_style(
      style = list(
        cell_fill(color = "#00ACF0")
      ),
      locations = cells_body(
        columns = c(`Second Year Participants`),
        rows = c(`Second Year Participants`) > 80
      )
    ) %>%
  tab_header(
    title = html("<strong>Difference in scores for 1st year vs returning participants<br> in Teaching Lab professional learning")
  ) %>%
  fmt_percent(
    columns = c(1, 2),
    scale_values = F,
    decimals = 0
  ) %>%
  fmt_markdown(
    columns = c(3)
  ) %>%
  gt_theme_tl() %>%
  gtsave(here("Images/2020-2021/ImpactReport/1stvs2ndyear.png"))
```

# Visual

```{r}
ggplot_data_compare <- gt_data_compare %>%
  pivot_longer(!c(Mindset), values_to = "score", names_to = "prepost") %>%
  rename(Question = Mindset) %>%
  mutate(Question = html_wrap(Question, interval = 20)) %>%
  mutate(prepost = str_replace_all(prepost, c("First Year Participants" = "Brand New",
                                              "Second Year Participants" = "Returning")))

ggplot_data_compare$Question <- factor(ggplot_data_compare$Question, levels = ggplot_data_compare$Question %>% unique() %>% as_vector() %>% rev())

ggplot(ggplot_data_compare, aes(x = Question, y = score, fill = prepost)) +
  geom_col(position = position_dodge2(reverse = T)) +
  geom_text(aes(label = paste0(score, "%"), color = prepost), position = position_dodge2(width = 1, reverse = T), hjust = -0.35, size = 5) +
  coord_flip() +
  labs(x = "", y = "", 
       title = "Comparing equitable mindsets for instruction <br>for brand new vs <span style = 'color:#04abeb'>returning partipants
       </span>") +
  scale_fill_tl(n = 2, labels = c("Brand New", "Returning")) +
  scale_color_tl(n = 2) +
  scale_y_continuous(labels = percent_format(scale = 1), limits = c(0, 105)) +
  theme_tl(legend = T) +
  theme(
    axis.text.y = element_markdown(size = 15, hjust = 0.5, lineheight = 1.1),
    plot.title = element_markdown(lineheight = 1.2, size = 20),
    axis.text.x = element_markdown(size = 15),
    legend.title = element_blank(),
    legend.position = c(0.9, 0.95),
    legend.text = element_markdown(size = 12))

ggsave(here::here("Images/2020-2021/ImpactReport/ScoresFirstvsSecondYear.png"), width = 11, height = 10)
```

```{r}
data <- read_rds(here::here("Data/SY20-21/full_2021.rds"))

ela_index <- tibble(question_pre = c("preelagen1a", "preelagen1b", "preelagen1c", "preelagen1d", 
"preelagen2", "preelafluency1a", "preelafluency1b", "preelafluency1c", 
"preelafluency1d", "preelafluency2", "preelatext1", "preelatext2a", 
"preelatext2b", "preelatext2c", "preelatext2d", "preelaevi1a", 
"preelaevi1b", "preelaevi1c", "preelaevi1d", "preelaevi2", 
"preelaknow1", "preelaknow2", "preelasupp1", "preelasupp2a", 
"preelasupp2b", "preelasupp2c", "preelasupp2d"),
                question_post = c("postelagen1a", "postelagen1b", "postelagen1c", "postelagen1d", 
"postelagen2", "postelafluency1a", "postelafluency1b", "postelafluency1c", 
"postelafluency1d", "postelafluency2", "postelatext1", "postelatext2a", 
"postelatext2b", "postelatext2c", "postelatext2d", "postelaevi1a", 
"postelaevi1b", "postelaevi1c", "postelaevi1d", "postelaevi2", 
"postelaknow1", "postelaknow2", "postelasupp1", "postelasupp2a", 
"postelasupp2b", "postelasupp2c", "postelasupp2d"),
                coding = list("Yes", 
                              "Yes", 
                              "No", 
                              "No", 
                              "A complex text that is worthy of reading multiple times.", 
                              "TRUE", 
                              "TRUE", 
                              "FALSE", 
                              "FALSE", 
                              "Students independently read aloud texts at their reading level.", 
                              "Ability to read complex text independently and proficiently.", 
                              "Yes", 
                              "Yes", 
                              "No", 
                              "No", 
                              "TRUE", 
                              "TRUE", 
                              "FALSE", 
                              "FALSE", 
                              "Students pull out evidence from the text to explain their thinking in response to questions.", 
                              "Students with low reading ability and a lot of knowledge about the food chain.", 
                              "Have students read a series of additional texts at a variety of complexity levels on the topic.", 
                              "Provide students with lower reading abilities an audio version of the main text to listen to before reading the main text in class.",
                              "Yes", 
                              "Yes", 
                              "No", 
                              "No"))

ela <- pmap_df(list(ela_index$question_pre, ela_index$question_post, ela_index$coding), ~ 
                                score_question_improved(data %>% filter(pre_priorpart == "Yes"), question_pre = ..1, question_post = ..2, 
                                                        coding = ..3, middle_value = "I'm not sure")) %>%
  mutate(across(c(1, 3), ~ round2(.x, 0))) %>%
  distinct(question, .keep_all = T)
ela2 <- pmap_df(list(ela_index$question_pre, ela_index$question_post, ela_index$coding), ~ 
                                score_question_improved(data %>% filter(pre_priorpart != "Yes"), question_pre = ..1, question_post = ..2, 
                                                        coding = ..3, middle_value = "I'm not sure")) %>%
  mutate(across(c(1, 3), ~ round2(.x, 0))) %>%
  distinct(question, .keep_all = T)

math_index <- tibble(question_pre = c("mathgen1a.x", "mathgen1b.x", "mathgen1c.x", "mathgen1d.x", 
"mathgen2.x", "mathgen3a.x", "mathgen3b.x", "mathgen3c.x", "mathgen3d.x", 
"matheq1.x", "matheq2a.x", "matheq2b.x", "matheq2c.x", "matheq2d.x", 
"matheq3.x", "mathsupp1.x", "mathsupp2a.x", "mathsupp2b.x", "mathsupp2c.x", 
"mathsupp2d.x", "matheff1a.x", "matheff1b.x", "matheff1c.x", 
"matheff1d.x", "matheff2.x", "matheff3.x"),
                question_post = c("mathgen1a.y", "mathgen1b.y", "mathgen1c.y", "mathgen1d.y", 
"mathgen2.y", "mathgen3a.y", "mathgen3b.y", "mathgen3c.y", "mathgen3d.y", 
"matheq1.y", "matheq2a.y", "matheq2b.y", "matheq2c.y", "matheq2d.y", 
"matheq3.y", "mathsupp1.y", "mathsupp2a.y", "mathsupp2b.y", "mathsupp2c.y", 
"mathsupp2d.y", "matheff1a.y", "matheff1b.y", "matheff1c.y", 
"matheff1d.y", "matheff2.y", "matheff3.y"),
                coding = list("Yes",
                              "Yes",
                              "No",
                              "No",
                              "Procedural knowledge should be built from conceptual understanding.",
                              "TRUE",
                              "TRUE",
                              "FALSE",
                              "FALSE",
                              "Creating opportunities for students to practice saying out loud how they solved for a problem.",
                              "TRUE",
                              "TRUE",
                              "FALSE",
                              "FALSE",
                              "Enables teachers to make in-the-moment decisions on how to respond to students with questions and prompts that probe, scaffold, and extend to meet various learning needs.",
                              "Identifying unfinished learning leading up to the current topic and teach 1-2 lessons targeting those prerequisites at the beginning of the topic.",
                              "Yes",
                              "Yes",
                              "No",
                              "No",
                              "TRUE",
                              "TRUE",
                              "FALSE",
                              "FALSE",
                              "What’s the first step?",
                              "Explicitly teaching students how to use certain representations."))

math <- pmap_df(list(math_index$question_pre, math_index$question_post, math_index$coding), ~ 
                                 score_question_improved(data %>% filter(pre_priorpart == "Yes"), question_pre = ..1, question_post = ..2, 
                                                         coding = ..3, middle_value = "I'm not sure"))
math2 <- pmap_df(list(math_index$question_pre, math_index$question_post, math_index$coding), ~ 
                                 score_question_improved(data %>% filter(pre_priorpart != "Yes"), question_pre = ..1, question_post = ..2, 
                                                         coding = ..3, middle_value = "I'm not sure"))

ela_gt <- tibble(
  rowname = c("Overall Score", "ELA instructional shifts", "Fluency", 
              "Text complexity", "Close reading", "Building knowledge",
              "Supporting students with unfinished learning"),
  `% of educators who held growth mindsets and/or high expectations Fall` = c(ela %>% 
                                                                                summarise(mean(pre_percent)) %>% 
                                                                                as_vector(),
                                                                              ela %>% 
                                                                                slice(c(1:5)) %>% 
                                                                                summarise(mean(pre_percent)) %>% 
                                                                                as_vector(), 
                                                                              ela %>% 
                                                                                slice(c(6:10)) %>% 
                                                                                summarise(mean(pre_percent)) %>% 
                                                                                as_vector(), 
                                                                              ela %>% 
                                                                                slice(c(11:15)) %>% 
                                                                                summarise(mean(pre_percent)) %>% 
                                                                                as_vector(), 
                                                                              ela %>% 
                                                                                slice(c(16:20)) %>% 
                                                                                summarise(mean(pre_percent)) %>% 
                                                                                as_vector(),
                                                                              ela %>% 
                                                                                slice(c(21:22)) %>% 
                                                                                summarise(mean(pre_percent)) %>% 
                                                                                as_vector(),
                                                                              ela %>% 
                                                                                slice(c(23:27)) %>% 
                                                                                summarise(mean(pre_percent)) %>% 
                                                                                as_vector()),
  `% of educators who held growth mindsets and/or high expectations Spring` = c(ela %>% 
                                                                                summarise(mean(post_percent)) %>% 
                                                                                as_vector(),
                                                                              ela %>% 
                                                                                slice(c(1:5)) %>% 
                                                                                summarise(mean(post_percent)) %>% 
                                                                                as_vector(), 
                                                                              ela %>% 
                                                                                slice(c(6:10)) %>% 
                                                                                summarise(mean(post_percent)) %>% 
                                                                                as_vector(), 
                                                                              ela %>% 
                                                                                slice(c(11:15)) %>% 
                                                                                summarise(mean(post_percent)) %>% 
                                                                                as_vector(), 
                                                                              ela %>% 
                                                                                slice(c(16:20)) %>% 
                                                                                summarise(mean(post_percent)) %>% 
                                                                                as_vector(),
                                                                              ela %>% 
                                                                                slice(c(21:22)) %>% 
                                                                                summarise(mean(post_percent)) %>% 
                                                                                as_vector(),
                                                                              ela %>% 
                                                                                slice(c(23:27)) %>% 
                                                                                summarise(mean(post_percent)) %>% 
                                                                                as_vector()),
  `Percentage point change of educators who held growth mindsets and/or high expectations Fall to Spring` = c(
    `% of educators who held growth mindsets and/or high expectations Spring` - `% of educators who held growth mindsets and/or high expectations Fall`
  ),
  `% of educators who improved or sustained growth mindsets and/or high expectations` = c(ela %>% 
                                                                                summarise(mean(percent_improve_sustain)) %>% 
                                                                                as_vector(),
                                                                              ela %>% 
                                                                                slice(c(1:5)) %>% 
                                                                                summarise(mean(percent_improve_sustain)) %>% 
                                                                                as_vector(), 
                                                                              ela %>% 
                                                                                slice(c(6:10)) %>% 
                                                                                summarise(mean(percent_improve_sustain)) %>% 
                                                                                as_vector(), 
                                                                              ela %>% 
                                                                                slice(c(11:15)) %>% 
                                                                                summarise(mean(percent_improve_sustain)) %>% 
                                                                                as_vector(), 
                                                                              ela %>% 
                                                                                slice(c(16:20)) %>% 
                                                                                summarise(mean(percent_improve_sustain)) %>% 
                                                                                as_vector(),
                                                                              ela %>% 
                                                                                slice(c(21:22)) %>% 
                                                                                summarise(mean(percent_improve_sustain)) %>% 
                                                                                as_vector(),
                                                                              ela %>% 
                                                                                slice(c(23:27)) %>% 
                                                                                summarise(mean(percent_improve_sustain)) %>% 
                                                                                as_vector())
) %>%
  mutate(across(!c(1), ~ round2(.x, 0)))

ela_gt2 <- tibble(
  rowname = c("Overall Score", "ELA instructional shifts", "Fluency", 
              "Text complexity", "Close reading", "Building knowledge",
              "Supporting students with unfinished learning"),
  `% of educators who held growth mindsets and/or high expectations Fall` = c(ela2 %>% 
                                                                                summarise(mean(pre_percent)) %>% 
                                                                                as_vector(),
                                                                              ela2 %>% 
                                                                                slice(c(1:5)) %>% 
                                                                                summarise(mean(pre_percent)) %>% 
                                                                                as_vector(), 
                                                                              ela2 %>% 
                                                                                slice(c(6:10)) %>% 
                                                                                summarise(mean(pre_percent)) %>% 
                                                                                as_vector(), 
                                                                              ela2 %>% 
                                                                                slice(c(11:15)) %>% 
                                                                                summarise(mean(pre_percent)) %>% 
                                                                                as_vector(), 
                                                                              ela2 %>% 
                                                                                slice(c(16:20)) %>% 
                                                                                summarise(mean(pre_percent)) %>% 
                                                                                as_vector(),
                                                                              ela2 %>% 
                                                                                slice(c(21:22)) %>% 
                                                                                summarise(mean(pre_percent)) %>% 
                                                                                as_vector(),
                                                                              ela2 %>% 
                                                                                slice(c(23:27)) %>% 
                                                                                summarise(mean(pre_percent)) %>% 
                                                                                as_vector()),
  `% of educators who held growth mindsets and/or high expectations Spring` = c(ela2 %>% 
                                                                                summarise(mean(post_percent)) %>% 
                                                                                as_vector(),
                                                                              ela2 %>% 
                                                                                slice(c(1:5)) %>% 
                                                                                summarise(mean(post_percent)) %>% 
                                                                                as_vector(), 
                                                                              ela2 %>% 
                                                                                slice(c(6:10)) %>% 
                                                                                summarise(mean(post_percent)) %>% 
                                                                                as_vector(), 
                                                                              ela2 %>% 
                                                                                slice(c(11:15)) %>% 
                                                                                summarise(mean(post_percent)) %>% 
                                                                                as_vector(), 
                                                                              ela2 %>% 
                                                                                slice(c(16:20)) %>% 
                                                                                summarise(mean(post_percent)) %>% 
                                                                                as_vector(),
                                                                              ela2 %>% 
                                                                                slice(c(21:22)) %>% 
                                                                                summarise(mean(post_percent)) %>% 
                                                                                as_vector(),
                                                                              ela2 %>% 
                                                                                slice(c(23:27)) %>% 
                                                                                summarise(mean(post_percent)) %>% 
                                                                                as_vector()),
  `Percentage point change of educators who held growth mindsets and/or high expectations Fall to Spring` = c(
    `% of educators who held growth mindsets and/or high expectations Spring` - `% of educators who held growth mindsets and/or high expectations Fall`
  ),
  `% of educators who improved or sustained growth mindsets and/or high expectations` = c(ela2 %>% 
                                                                                summarise(mean(percent_improve_sustain)) %>% 
                                                                                as_vector(),
                                                                              ela2 %>% 
                                                                                slice(c(1:5)) %>% 
                                                                                summarise(mean(percent_improve_sustain)) %>% 
                                                                                as_vector(), 
                                                                              ela2 %>% 
                                                                                slice(c(6:10)) %>% 
                                                                                summarise(mean(percent_improve_sustain)) %>% 
                                                                                as_vector(), 
                                                                              ela2 %>% 
                                                                                slice(c(11:15)) %>% 
                                                                                summarise(mean(percent_improve_sustain)) %>% 
                                                                                as_vector(), 
                                                                              ela2 %>% 
                                                                                slice(c(16:20)) %>% 
                                                                                summarise(mean(percent_improve_sustain)) %>% 
                                                                                as_vector(),
                                                                              ela2 %>% 
                                                                                slice(c(21:22)) %>% 
                                                                                summarise(mean(percent_improve_sustain)) %>% 
                                                                                as_vector(),
                                                                              ela2 %>% 
                                                                                slice(c(23:27)) %>% 
                                                                                summarise(mean(percent_improve_sustain)) %>% 
                                                                                as_vector())
) %>%
  mutate(across(!c(1), ~ round2(.x, 0)))

math_gt <- tibble(
  rowname = c("Overall Score", "Math Instructional shifts", "Equitable Math Instruction", 
              "Supporting students with unfinished learning (math)", "Effective Teaching Practices"),
  `% of educators who held growth mindsets and/or high expectations Fall` = c(math %>% 
                                                                                summarise(mean(pre_percent)) %>% 
                                                                                as_vector(),
                                                                              math %>% 
                                                                                slice(c(1:9)) %>% 
                                                                                summarise(mean(pre_percent)) %>% 
                                                                                as_vector(), 
                                                                              math %>% 
                                                                                slice(c(10:15)) %>% 
                                                                                summarise(mean(pre_percent)) %>% 
                                                                                as_vector(), 
                                                                              math %>% 
                                                                                slice(c(16:20)) %>% 
                                                                                summarise(mean(pre_percent)) %>% 
                                                                                as_vector(), 
                                                                              math %>% 
                                                                                slice(c(21:26)) %>% 
                                                                                summarise(mean(pre_percent)) %>% 
                                                                                as_vector()),
  `% of educators who held growth mindsets and/or high expectations Spring` = c(math %>% 
                                                                                summarise(mean(post_percent)) %>% 
                                                                                as_vector(),
                                                                              math %>% 
                                                                                slice(c(1:9)) %>% 
                                                                                summarise(mean(post_percent)) %>% 
                                                                                as_vector(), 
                                                                              math %>% 
                                                                                slice(c(10:15)) %>% 
                                                                                summarise(mean(post_percent)) %>% 
                                                                                as_vector(), 
                                                                              math %>% 
                                                                                slice(c(16:20)) %>% 
                                                                                summarise(mean(post_percent)) %>% 
                                                                                as_vector(), 
                                                                              math %>% 
                                                                                slice(c(21:26)) %>% 
                                                                                summarise(mean(post_percent)) %>% 
                                                                                as_vector()),
  `Percentage point change of educators who held growth mindsets and/or high expectations Fall to Spring` = c(
    `% of educators who held growth mindsets and/or high expectations Spring` - `% of educators who held growth mindsets and/or high expectations Fall`
  ),
  `% of educators who improved or sustained growth mindsets and/or high expectations` = c(math %>% 
                                                                                summarise(mean(percent_improve_sustain)) %>% 
                                                                                as_vector(),
                                                                              math %>% 
                                                                                slice(c(1:9)) %>% 
                                                                                summarise(mean(percent_improve_sustain)) %>% 
                                                                                as_vector(), 
                                                                              math %>% 
                                                                                slice(c(10:15)) %>% 
                                                                                summarise(mean(percent_improve_sustain)) %>% 
                                                                                as_vector(), 
                                                                              math %>% 
                                                                                slice(c(16:20)) %>% 
                                                                                summarise(mean(percent_improve_sustain)) %>% 
                                                                                as_vector(), 
                                                                              math %>% 
                                                                                slice(c(21:26)) %>% 
                                                                                summarise(mean(percent_improve_sustain)) %>% 
                                                                                as_vector())
) %>%
  mutate(across(!c(1), ~ round2(.x, 0)))

math_gt2 <- tibble(
  rowname = c("Overall Score", "Math Instructional shifts", "Equitable Math Instruction", 
              "Supporting students with unfinished learning (math)", "Effective Teaching Practices"),
  `% of educators who held growth mindsets and/or high expectations Fall` = c(math2 %>% 
                                                                                summarise(mean(pre_percent)) %>% 
                                                                                as_vector(),
                                                                              math2 %>% 
                                                                                slice(c(1:9)) %>% 
                                                                                summarise(mean(pre_percent)) %>% 
                                                                                as_vector(), 
                                                                              math2 %>% 
                                                                                slice(c(10:15)) %>% 
                                                                                summarise(mean(pre_percent)) %>% 
                                                                                as_vector(), 
                                                                              math2 %>% 
                                                                                slice(c(16:20)) %>% 
                                                                                summarise(mean(pre_percent)) %>% 
                                                                                as_vector(), 
                                                                              math2 %>% 
                                                                                slice(c(21:26)) %>% 
                                                                                summarise(mean(pre_percent)) %>% 
                                                                                as_vector()),
  `% of educators who held growth mindsets and/or high expectations Spring` = c(math2 %>% 
                                                                                summarise(mean(post_percent)) %>% 
                                                                                as_vector(),
                                                                              math2 %>% 
                                                                                slice(c(1:9)) %>% 
                                                                                summarise(mean(post_percent)) %>% 
                                                                                as_vector(), 
                                                                              math2 %>% 
                                                                                slice(c(10:15)) %>% 
                                                                                summarise(mean(post_percent)) %>% 
                                                                                as_vector(), 
                                                                              math2 %>% 
                                                                                slice(c(16:20)) %>% 
                                                                                summarise(mean(post_percent)) %>% 
                                                                                as_vector(), 
                                                                              math2 %>% 
                                                                                slice(c(21:26)) %>% 
                                                                                summarise(mean(post_percent)) %>% 
                                                                                as_vector()),
  `Percentage point change of educators who held growth mindsets and/or high expectations Fall to Spring` = c(
    `% of educators who held growth mindsets and/or high expectations Spring` - `% of educators who held growth mindsets and/or high expectations Fall`
  ),
  `% of educators who improved or sustained growth mindsets and/or high expectations` = c(math2 %>% 
                                                                                summarise(mean(percent_improve_sustain)) %>% 
                                                                                as_vector(),
                                                                              math2 %>% 
                                                                                slice(c(1:9)) %>% 
                                                                                summarise(mean(percent_improve_sustain)) %>% 
                                                                                as_vector(), 
                                                                              math2 %>% 
                                                                                slice(c(10:15)) %>% 
                                                                                summarise(mean(percent_improve_sustain)) %>% 
                                                                                as_vector(), 
                                                                              math2 %>% 
                                                                                slice(c(16:20)) %>% 
                                                                                summarise(mean(percent_improve_sustain)) %>% 
                                                                                as_vector(), 
                                                                              math2 %>% 
                                                                                slice(c(21:26)) %>% 
                                                                                summarise(mean(percent_improve_sustain)) %>% 
                                                                                as_vector())
) %>%
  mutate(across(!c(1), ~ round2(.x, 0)))

just_math <- bind_cols(math_gt %>% select(1, 2), math_gt2 %>% select(2)) %>%
  rename(Question = 1, Returning = 2, `Brand New` = 3) %>%
  pivot_longer(!Question, names_to = "prepost", values_to = "score") %>%
  mutate(Question = html_wrap(Question, interval = 30))

just_ela <- bind_cols(ela_gt %>% select(1, 2), ela_gt2 %>% select(2)) %>%
  rename(Question = 1, Returning = 2, `Brand New` = 3) %>%
  pivot_longer(!Question, names_to = "prepost", values_to = "score") %>%
  mutate(Question = html_wrap(Question, interval = 30))

just_ela$Question <- factor(just_ela$Question, levels = just_ela$Question %>% unique() %>% as_vector() %>% rev())

just_math$Question <- factor(just_math$Question, levels = just_math$Question %>% unique() %>% as_vector() %>% rev())

ggplot(just_ela, aes(x = Question, y = score, fill = prepost)) +
  geom_col(position = position_dodge2(reverse = T)) +
  geom_text(aes(label = paste0(score, "%"), color = prepost), position = position_dodge2(width = 1, reverse = T), hjust = -0.35, size = 5) +
  coord_flip() +
  labs(x = "", y = "",
       title = "Comparing content and pedagogical content knowledge<br>for brand new vs <span style = 'color:#04abeb'>returning ELA participants
       </span>") +
  scale_fill_tl(n = 2, labels = c("First Year\nParticipants", "Second Year\nParticipants")) +
  scale_color_tl(n = 2) +
  scale_y_continuous(labels = percent_format(scale = 1), limits = c(0, 105)) +
  theme_tl(legend = T) +
  theme(
    axis.text.y = element_markdown(size = 15, hjust = 0.5, lineheight = 1.1),
    plot.title = element_markdown(lineheight = 1.2, size = 20),
    axis.text.x = element_markdown(size = 15),
    legend.position = c(0.9, 0.95),
    legend.title = element_blank(),
    legend.key.size = unit(1.25, "cm"),
    legend.text = element_text(size = 12))

ggsave(here::here("Images/2020-2021/ImpactReport/ELAContentComparison.png"), width = 10, height = 14)


ggplot(just_math, aes(x = Question, y = score, fill = prepost)) +
  geom_col(position = position_dodge2(reverse = T)) +
  geom_text(aes(label = paste0(score, "%"), color = prepost), position = position_dodge2(width = 1, reverse = T), hjust = -0.35, size = 5) +
  coord_flip() +
  labs(x = "", y = "",
       title = "Comparing content and pedagogical content knowledge<br>for brand new vs <span style = 'color:#04abeb'>returning math participants
       </span>") +
  scale_fill_tl(n = 2, labels = c("First Year\nParticipants", "Second Year\nParticipants")) +
  scale_color_tl(n = 2) +
  scale_y_continuous(labels = percent_format(scale = 1), limits = c(0, 105)) +
  theme_tl(legend = T) +
  theme(
    axis.text.y = element_markdown(size = 15, hjust = 0.5, lineheight = 1.1),
    plot.title = element_markdown(lineheight = 1.2, size = 20),
    axis.text.x = element_markdown(size = 15),
    legend.position = c(0.9, 0.95),
    legend.title = element_blank(),
    legend.key.size = unit(1.25, "cm"),
    legend.text = element_text(size = 12))
ggsave(here::here("Images/2020-2021/ImpactReport/MathContentComparison.png"), width = 10, height = 14)
```



# Student Work Table

```{r}
data <- read_sheet("https://docs.google.com/spreadsheets/d/1ZZnizhPVjL8BBenwAeSKcTU1GYKpZYdEUe_-95V5Ej0/edit#gid=239657167",
                   sheet = "Scoring2",
                   col_names = c("Link", "ID", "Score", "Name", "Prepost", "Grade", "Curriculum"))

data_clean <- data %>% 
  filter(!str_detect(Score, "No Response|NULL|Not|No response")) %>%
  # mutate(Score = as.numeric(as.character(Score))) %>%
  # drop_na(Score) %>%
  select(-1) %>%
  mutate(Name = unlist(Name))

gt3 <- data_clean %>%
  mutate(Score = as.numeric(unlist(Score))) %>%
  mutate(Score = replace_na(Score, 0)) %>%
  group_by(Curriculum, Prepost) %>%
  summarise(Score = round(mean(Score), 2)) %>%
  mutate(Prepost = str_replace_all(Prepost, c("Pre" = "Fall", "Post" = "Spring"))) %>%
  pivot_wider(names_from = "Prepost", values_from = "Score", names_sort = T) %>%
  ungroup()

gt3 %>%
  gt(rowname_col = "Curriculum") %>%
  tab_header(title = "\U1F605    Average Fall & Spring Homework Scores of Students of Teaching Lab Teachers     \U1F605") %>%
  data_color(
    columns = c(Spring),
    colors = scales::col_numeric(
      palette = paletteer::paletteer_d(
        palette = "ggsci::blue_material"
      ) %>% as.character(),
      domain = NULL
    )
  ) %>%
  tab_source_note(source_note = "Fall ELA n = 68, Spring ELA n = 22, Fall Math n = 30, Spring Math n = 14") %>%
  gt_theme_tl(all_caps = T) %>%
  gtsave(here::here("Images/2020-2021/ImpactReport/StudentWork.png"))
```

# Student Work Percent who Improved

```{r}
data <- read_sheet("https://docs.google.com/spreadsheets/d/1ZZnizhPVjL8BBenwAeSKcTU1GYKpZYdEUe_-95V5Ej0/edit#gid=239657167",
                   sheet = "Scoring2",
                   col_names = c("Link", "ID", "Score", "Name", "Prepost", "Grade", "Curriculum"))

data_clean <- data %>% 
  filter(!str_detect(Score, "No Response|NULL|Not|No response")) %>%
  # mutate(Score = as.numeric(as.character(Score))) %>%
  # drop_na(Score) %>%
  select(-1) %>%
  mutate(Name = unlist(Name))

data_clean %>%
  summarise(100-100*sum(Score == "Below grade-level")/n())

(student_improve <- data_clean %>%
  pivot_wider(names_from = "Prepost", values_from = "Score") %>%
  filter(Pre != "NULL" & Post != "NULL") #%>%
  # summarise(sum(Pre == "0" & Post == "1" | Pre == "1" & Post == "2" | Pre == "Below grade-level" & Post == "2" |
  #                 Pre == "Below grade-level" & Post == "1")/n())
  )
```



